// Estado do t√©cnico
let tecnicoAtual = null;
let ticketSelecionado = null;
let tickets = [];
let mensagens = [];

// Inicializar p√°gina
function inicializarPagina() {
    console.log('üöÄ Inicializando p√°gina do t√©cnico');
    
    // Aguardar carregamento completo
    setTimeout(() => {
        // Carregar dados do usu√°rio dos cookies primeiro, depois localStorage como fallback
        let usuarioStorage = getCookie('usuarioAtual');
        if (!usuarioStorage) {
            console.log('‚ö†Ô∏è Nenhum cookie de usu√°rio encontrado, tentando localStorage...');
            usuarioStorage = localStorage.getItem('usuarioAtual');
        }
        
        if (usuarioStorage) {
            try {
                const dadosUsuario = JSON.parse(usuarioStorage);
                console.log('üìã Dados do usu√°rio carregados dos cookies:', dadosUsuario);
                
                tecnicoAtual = {
                    id: dadosUsuario.id || 2,
                    username: dadosUsuario.email,
                    role: dadosUsuario.role || 'Technician',
                    specs: ['Hardware', 'Software'] // Em produ√ß√£o, viria da API
                };
                console.log('‚úÖ T√©cnico autenticado:', tecnicoAtual.username);
            } catch (error) {
                console.error('‚ùå Erro ao carregar dados do t√©cnico:', error);
                tecnicoAtual = {
                    id: 2,
                    username: 'T√©cnico Demo',
                    role: 'Technician',
                    specs: ['Hardware', 'Software']
                };
                console.log('‚ö†Ô∏è Usando dados demo devido a erro');
            }
        } else {
            console.log('‚ö†Ô∏è Nenhum dado de usu√°rio encontrado nos cookies nem localStorage - usando dados demo');
            tecnicoAtual = {
                id: 2,
                username: 'T√©cnico Demo',
                role: 'Technician',
                specs: ['Hardware', 'Software']
            };
        }
        
        finalizarInicializacaoTecnico();
    }, 100);
}

function finalizarInicializacaoTecnico() {
    // Atualizar info do usu√°rio no header
    const infoUsuario = document.querySelector('.user-info span');
    if (infoUsuario) {
        infoUsuario.textContent = tecnicoAtual.username;
    }
    
    // Configurar entrada de chat
    configurarEntradaChat();
    
    // Carregar tickets do t√©cnico
    carregarTicketsTecnico();
}

// Carregar tickets atribu√≠dos ao t√©cnico
async function carregarTicketsTecnico() {
    try {
        console.log('üé´ Carregando tickets do t√©cnico:', tecnicoAtual.id);
        // GET /Ticket - Lista todos os tickets (filtrar no cliente se necess√°rio)
        tickets = await suporteAPI.chamarAPI('/Ticket');
        console.log('‚úÖ Tickets carregados:', tickets.length);
        renderizarListaTickets();
    } catch (error) {
        console.error('‚ùå Erro ao carregar tickets do t√©cnico:', error);
        suporteAPI.mostrarMensagem('Erro ao carregar tickets', 'error');
    }
}

// Carregar mensagens do ticket
async function carregarMensagens(ticketId) {
    try {
        console.log('üí¨ Carregando mensagens do ticket:', ticketId);
        
        const resultado = await suporteAPI.chamarAPI(`/Message/${ticketId}`, 'GET');
        
        if (resultado.sucesso) {
            mensagens = resultado.dados || [];
            console.log('‚úÖ Mensagens carregadas com sucesso:', mensagens.length, 'mensagens');
        } else {
            console.log('‚ö†Ô∏è N√£o foi poss√≠vel carregar mensagens, usando lista vazia');
            mensagens = [];
        }
        
        renderizarMensagensChat();
    } catch (error) {
        console.error('‚ùå Erro ao carregar mensagens:', error);
        console.log('‚ö†Ô∏è Usando lista vazia como fallback');
        mensagens = [];
        renderizarMensagensChat();  
        suporteAPI.mostrarMensagem('Erro ao carregar mensagens', 'error');
    }
}

// Renderizar lista de tickets
function renderizarListaTickets() {
    const listaTickets = document.getElementById('ticket-list');
    if (!listaTickets) return;
    
    listaTickets.innerHTML = '';
    console.log('Renderizando', tickets.length, 'tickets do t√©cnico');
    
    const ticketsAbertos = tickets.filter(ticket => ticket.status !== 'Fechado');
    
    ticketsAbertos.forEach(ticket => {
        const elementoTicket = document.createElement('div');
        elementoTicket.className = 'list-item';
        elementoTicket.onclick = () => selecionarTicket(ticket);
        
        elementoTicket.innerHTML = `
            <div class="ticket-title">${ticket.title}</div>
            <div class="ticket-status ${suporteAPI.obterClasseStatus(ticket.status)}">
                <span class="status-badge">${ticket.status}</span>
            </div>
            <div style="font-size: 0.8rem; color: #666; margin-top: 0.5rem;">
                ${suporteAPI.formatarData(ticket.createdAt)}
            </div>
        `;
        
        listaTickets.appendChild(elementoTicket);
    });
}

// Selecionar ticket
async function selecionarTicket(ticket) {
    console.log('Ticket selecionado pelo t√©cnico:', ticket.title);
    ticketSelecionado = ticket;
    
    // Atualizar estado ativo
    document.querySelectorAll('.list-item').forEach(item => {
        item.classList.remove('active');
    });
    event.currentTarget.classList.add('active');
    
    // Carregar mensagens
    carregarMensagens(ticket.id);
    
    // Atualizar cabe√ßalho do chat
    const cabecalhoChat = document.getElementById('chat-header');
    if (cabecalhoChat) {
        cabecalhoChat.textContent = `Chat - ${ticket.title}`;
    }
    
    // Atualizar detalhes do ticket
    atualizarDetalhesTicket(ticket);
    
    // Carregar informa√ß√µes do colaborador
    await carregarInfoColaborador(ticket.userId);
}

// Renderizar mensagens do chat
function renderizarMensagensChat() {
    const chatMensagens = document.getElementById('chat-messages');
    if (!chatMensagens) return;
    
    chatMensagens.innerHTML = '';
    console.log('Renderizando', mensagens.length, 'mensagens');
    
    mensagens.forEach(mensagem => {
        if (mensagem.userText) {
            const elementoMensagem = document.createElement('div');
            elementoMensagem.className = 'message user';
            elementoMensagem.innerHTML = `
                <div>${mensagem.userText}</div>
                <div class="message-time">${suporteAPI.formatarData(mensagem.time)}</div>
            `;
            chatMensagens.appendChild(elementoMensagem);
        }
        
        if (mensagem.botText) {
            const elementoMensagemBot = document.createElement('div');
            elementoMensagemBot.className = 'message bot';
            elementoMensagemBot.innerHTML = `
                <div>${mensagem.botText}</div>
                <div class="message-time">${suporteAPI.formatarData(mensagem.time)}</div>
            `;
            chatMensagens.appendChild(elementoMensagemBot);
        }
    });
    
    chatMensagens.scrollTop = chatMensagens.scrollHeight;
}

// Atualizar detalhes do ticket
function atualizarDetalhesTicket(ticket) {
    const elementos = {
        'ticket-status': ticket.status,
        'ticket-title': ticket.title,
        'ticket-description': ticket.description,
        'ticket-created': suporteAPI.formatarData(ticket.createdAt)
    };
    
    Object.entries(elementos).forEach(([id, valor]) => {
        const elemento = document.getElementById(id);
        if (elemento) {
            elemento.textContent = valor;
        }
    });
}

// Carregar informa√ß√µes do colaborador
async function carregarInfoColaborador(userId) {
    try {
        console.log('üë§ Carregando informa√ß√µes do colaborador:', userId);
        // GET /User/{id} - Buscar usu√°rio por ID
        const usuario = await suporteAPI.chamarAPI(`/User/${userId}`);
        console.log('‚úÖ Dados do colaborador carregados:', usuario.username);
        
        document.getElementById('user-name').textContent = usuario.username;
        document.getElementById('user-email').textContent = usuario.email;
        
        // Carregar contagem de tickets do usu√°rio - filtrar localmente
        console.log('üìã Carregando hist√≥rico de tickets do usu√°rio...');
        const todosTickets = await suporteAPI.chamarAPI('/Ticket');
        const ticketsUsuario = todosTickets.filter(ticket => ticket.userId === userId);
        console.log('‚úÖ Tickets do usu√°rio encontrados:', ticketsUsuario.length);
        document.getElementById('user-ticket-count').textContent = ticketsUsuario.length;
        
    } catch (error) {
        console.error('‚ùå Erro ao carregar informa√ß√µes do colaborador:', error);
        suporteAPI.mostrarMensagem('Erro ao carregar informa√ß√µes do colaborador', 'error');
    }
}

// Configurar entrada de chat (t√©cnico apenas l√™ mensagens)
function configurarEntradaChat() {
    const entradaChat = document.getElementById('chat-input');
    const botaoEnviar = document.getElementById('send-btn');
    
    if (entradaChat && botaoEnviar) {
        // Desabilitar entrada de chat para t√©cnicos
        entradaChat.disabled = true;
        entradaChat.placeholder = 'T√©cnicos n√£o podem enviar mensagens de chat';
        entradaChat.style.backgroundColor = '#f5f5f5';
        entradaChat.style.color = '#999';
        
        // Desabilitar bot√£o de enviar
        botaoEnviar.disabled = true;
        botaoEnviar.style.backgroundColor = '#ccc';
        botaoEnviar.style.cursor = 'not-allowed';
        
        console.log('Entrada de chat desabilitada para t√©cnico - apenas leitura');
    }
}

// Enviar mensagem de sistema (apenas para resolu√ß√µes)
async function enviarMensagemSistema(ticketId, textoResolucao, autorId) {
    try {
        console.log('Enviando mensagem de resolu√ß√£o:', textoResolucao);
        
        const dadosMensagem = {
            ticketId: ticketId,
            userText: textoResolucao,
            authorId: autorId,
            time: new Date().toISOString()
        };
        
        await suporteAPI.chamarAPI('/Message', 'POST', dadosMensagem);
        await carregarMensagens(ticketId);
        suporteAPI.mostrarMensagem('Resolu√ß√£o registrada com sucesso', 'success');
    } catch (error) {
        console.error('Erro ao registrar resolu√ß√£o:', error);
    }
}

// Atualizar status do ticket
async function atualizarStatusTicket() {
    if (!ticketSelecionado) {
        suporteAPI.mostrarMensagem('Selecione um ticket primeiro', 'error');
        return;
    }
    
    try {
        console.log('üîÑ Atualizando status do ticket para Em Andamento');
        // ‚ö†Ô∏è N√£o h√° endpoint espec√≠fico para mudar status gen√©rico
        // Usando apenas logs por enquanto at√© implementa√ß√£o do backend
        console.log('‚ö†Ô∏è Endpoint para atualizar status n√£o implementado - usando apenas logs');
        await carregarTicketsTecnico();
        suporteAPI.mostrarMensagem('Status atualizado para Em Andamento', 'success');
    } catch (error) {
        console.error('Erro ao atualizar status:', error);
    }
}

// Fun√ß√£o removida: T√©cnicos n√£o podem enviar mensagens de chat
// Apenas podem ler mensagens e registrar resolu√ß√µes

// Resolver ticket
function resolverTicket() {
    if (!ticketSelecionado) {
        suporteAPI.mostrarMensagem('Selecione um ticket primeiro', 'error');
        return;
    }
    
    const textoResolucao = document.getElementById('resolution-text').value.trim();
    if (!textoResolucao) {
        suporteAPI.mostrarMensagem('Por favor, insira o texto da resolu√ß√£o', 'error');
        return;
    }
    
    console.log('Preparando resolu√ß√£o do ticket');
    // Mostrar modal de confirma√ß√£o
    document.getElementById('modal-ticket-title').textContent = ticketSelecionado.title;
    document.getElementById('modal-resolution-preview').textContent = textoResolucao;
    suporteAPI.abrirModal('resolve-ticket-modal');
}

// Confirmar resolu√ß√£o do ticket
async function confirmarResolucaoTicket() {
    const textoResolucao = document.getElementById('resolution-text').value.trim();
    
    try {
        console.log('‚úÖ Confirmando resolu√ß√£o do ticket');
        
        // Enviar mensagem de sistema com a resolu√ß√£o
        await enviarMensagemSistema(ticketSelecionado.id, `Resolu√ß√£o: ${textoResolucao}`, tecnicoAtual.id);
        
        // PATCH /Ticket/{id}/finish - Finalizar ticket
        await suporteAPI.chamarAPI(`/Ticket/${ticketSelecionado.id}/finish`, 'PATCH', textoResolucao);
        
        // Limpar campo de resolu√ß√£o
        document.getElementById('resolution-text').value = '';
        
        // Fechar modal
        suporteAPI.fecharModal('resolve-ticket-modal');
        
        // Recarregar tickets
        await carregarTicketsTecnico();
        
        suporteAPI.mostrarMensagem('Ticket resolvido com sucesso!', 'success');
        
    } catch (error) {
        console.error('Erro ao resolver ticket:', error);
    }
}

// Event listeners
document.addEventListener('DOMContentLoaded', () => {
    inicializarPagina();
});